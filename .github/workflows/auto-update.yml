name: è‡ªåŠ¨æ›´æ–°å½©ç¥¨æ•°æ®å’Œæ¨¡å‹

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ™šä¸Š9ç‚¹è¿è¡Œï¼ˆUTC+8 = 13:00 UTCï¼‰
    - cron: '0 13 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install python-dotenv; fi
      
      - name: é‡‡é›†æœ€æ–°æ•°æ®
        run: |
          python scripts/collect_data.py
          echo "æ•°æ®é‡‡é›†å®Œæˆ"
      
      - name: è®­ç»ƒæ¨¡å‹
        run: |
          python scripts/train_model.py
          echo "æ¨¡å‹è®­ç»ƒå®Œæˆ"
      
      - name: å¤åˆ¶æ¨¡å‹åˆ°APIç›®å½•
        run: |
          cp data/models/frequency_model.pkl api/frequency_model.pkl
          echo "æ¨¡å‹å·²æ›´æ–°åˆ°APIç›®å½•"
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        id: check_changes
        run: |
          git diff --quiet data/raw/history.json api/frequency_model.pkl || echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: æäº¤æ›´æ–°
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/raw/history.json api/frequency_model.pkl
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: é€šçŸ¥æ›´æ–°å®Œæˆ
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "âœ… æ•°æ®å’Œæ¨¡å‹å·²è‡ªåŠ¨æ›´æ–°å¹¶æ¨é€åˆ°GitHub"
          echo "Vercelå°†è‡ªåŠ¨éƒ¨ç½²æ–°ç‰ˆæœ¬"