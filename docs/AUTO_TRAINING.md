# è‡ªåŠ¨æ•°æ®åŒæ­¥å’Œæ¨¡å‹è®­ç»ƒåŠŸèƒ½

## æ¦‚è¿°

æœ¬ç³»ç»Ÿå·²å®ç°**æ·»åŠ æ•°æ®åè‡ªåŠ¨è§¦å‘æ•°æ®åŒæ­¥å’Œæ¨¡å‹è®­ç»ƒ**çš„åŠŸèƒ½ã€‚å½“æ‚¨åœ¨åå°ç®¡ç†ç•Œé¢æ·»åŠ æ–°çš„å¼€å¥–æ•°æ®æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š

1. âœ… æ›´æ–°æœ¬åœ°æ•°æ®æ–‡ä»¶ `_lottery_data.py`
2. âœ… åŒæ­¥æ•°æ®åˆ°è…¾è®¯äº‘COSå­˜å‚¨æ¡¶
3. âœ… è‡ªåŠ¨è§¦å‘MLæ¨¡å‹å¢é‡è®­ç»ƒï¼ˆåå°å¼‚æ­¥æ‰§è¡Œï¼‰
4. âœ… è®­ç»ƒå®Œæˆåä¸Šä¼ æ–°æ¨¡å‹åˆ°COS

---

## åŠŸèƒ½æ¶æ„

```
ç”¨æˆ·æ·»åŠ æ•°æ®
    â†“
ä¿å­˜åˆ° /tmp/user_lottery_data.json
    â†“
è‡ªåŠ¨è§¦å‘åŒæ­¥æµç¨‹
    â”œâ”€â†’ æ›´æ–° api/utils/_lottery_data.py
    â”œâ”€â†’ ä¸Šä¼ åˆ°è…¾è®¯äº‘COS
    â””â”€â†’ è§¦å‘åå°è®­ç»ƒä»»åŠ¡
            â”œâ”€â†’ å‡†å¤‡è®­ç»ƒæ•°æ®
            â”œâ”€â†’ è®­ç»ƒ4ç§MLæ¨¡å‹
            â””â”€â†’ ä¸Šä¼ æ¨¡å‹åˆ°COS
```

---

## æ ¸å¿ƒæ¨¡å—

### 1. æ•°æ®åŒæ­¥æ¨¡å— (`api/utils/_data_sync.py`)

**åŠŸèƒ½**ï¼š
- å°†æ–°å¢æ•°æ®åˆå¹¶åˆ° `_lottery_data.py`
- ä¸Šä¼ æ›´æ–°åçš„æ•°æ®åˆ°è…¾è®¯äº‘COS

**ä¸»è¦å‡½æ•°**ï¼š
```python
sync_new_data(new_records, combined_data)
```

### 2. è®­ç»ƒè§¦å‘å™¨ (`api/utils/_training_trigger.py`)

**åŠŸèƒ½**ï¼š
- åœ¨åå°çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œæ¨¡å‹è®­ç»ƒ
- å‡†å¤‡è®­ç»ƒæ•°æ®ï¼ˆç‰¹å¾æå– + æ•°æ®åˆ’åˆ†ï¼‰
- è°ƒç”¨è®­ç»ƒè„šæœ¬è®­ç»ƒ4ç§æ¨¡å‹ï¼ˆRandom Forestã€XGBoostã€LSTMã€Transformerï¼‰
- ä¸Šä¼ è®­ç»ƒå¥½çš„æ¨¡å‹åˆ°COS

**ä¸»è¦å‡½æ•°**ï¼š
```python
trigger_training(combined_data)
get_training_status()
```

### 3. ç®¡ç†APIå¢å¼º (`api/admin-data.py`)

**æ–°å¢åŠŸèƒ½**ï¼š
- æ·»åŠ æ•°æ®æˆåŠŸåè‡ªåŠ¨è°ƒç”¨åŒæ­¥å’Œè®­ç»ƒ
- æ–°å¢ `training_status` æ“ä½œæŸ¥è¯¢è®­ç»ƒè¿›åº¦

---

## ä½¿ç”¨æ–¹æ³•

### 1. æ·»åŠ å¼€å¥–æ•°æ®

**å‰ç«¯æ“ä½œ**ï¼š
1. è®¿é—®åå°ç®¡ç†é¡µé¢ `/admin.html`
2. å¡«å†™æœŸå·ã€æ—¥æœŸã€å‰åŒº5ä¸ªå·ç ã€ååŒº2ä¸ªå·ç 
3. ç‚¹å‡»"æ·»åŠ æ•°æ®"

**åå°è‡ªåŠ¨æ‰§è¡Œ**ï¼š
```
âœ… æ•°æ®ä¿å­˜æˆåŠŸ
âœ… æ•°æ®å·²åŒæ­¥: æœ¬åœ°æ–‡ä»¶âœ… + COSâœ…
âœ… æ¨¡å‹è®­ç»ƒå·²å¯åŠ¨ï¼ˆåå°è¿è¡Œï¼‰
```

### 2. æŸ¥è¯¢è®­ç»ƒçŠ¶æ€

**APIè¯·æ±‚**ï¼š
```bash
curl -X POST https://your-domain.com/api/admin-data \
  -H "Content-Type: application/json" \
  -d '{"action": "training_status"}'
```

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "status": "success",
  "training": {
    "status": "running",
    "message": "æ­£åœ¨è®­ç»ƒæ¨¡å‹...",
    "started_at": "2026-01-25T12:00:00",
    "updated_at": "2026-01-25T12:05:00"
  }
}
```

**è®­ç»ƒçŠ¶æ€è¯´æ˜**ï¼š
- `idle`: æœªè¿è¡Œ
- `running`: æ­£åœ¨è®­ç»ƒ
- `completed`: è®­ç»ƒå®Œæˆ
- `failed`: è®­ç»ƒå¤±è´¥

### 3. æŸ¥çœ‹è®­ç»ƒæ—¥å¿—

è®­ç»ƒæ—¥å¿—ä¿å­˜åœ¨ï¼š
```
/tmp/training_log.txt
```

---

## å·¥ä½œæµç¨‹è¯¦è§£

### è‡ªåŠ¨åŒ–æµç¨‹

#### æ­¥éª¤1ï¼šç”¨æˆ·æ·»åŠ æ•°æ®
```python
POST /api/admin-data
{
  "action": "add",
  "period": "25142",
  "date": "2026-01-25",
  "front": [2, 3, 9, 14, 29],
  "back": [2, 4]
}
```

#### æ­¥éª¤2ï¼šä¿å­˜æ•°æ®
- ä¿å­˜åˆ° `/tmp/user_lottery_data.json`
- ä¸å›ºå®šæ•°æ®åˆå¹¶

#### æ­¥éª¤3ï¼šæ•°æ®åŒæ­¥
**3.1 æ›´æ–°æœ¬åœ°æ–‡ä»¶**
```python
# æ›´æ–° api/utils/_lottery_data.py
LOTTERY_HISTORY = [
    ["25142", 2, 3, 9, 14, 29, 2, 4, "2026-01-25"],  # æ–°å¢
    ["25141", ...],  # åŸæœ‰æ•°æ®
    ...
]
```

**3.2 ä¸Šä¼ åˆ°COS**
```
ğŸ“¤ ä¸Šä¼ åˆ°: cos://your-bucket/data/lottery_history.json
```

#### æ­¥éª¤4ï¼šè§¦å‘è®­ç»ƒï¼ˆåå°çº¿ç¨‹ï¼‰
```python
Thread(target=training_task).start()
```

**è®­ç»ƒä»»åŠ¡æµç¨‹**ï¼š
1. å‡†å¤‡è®­ç»ƒæ•°æ®ï¼ˆç‰¹å¾å·¥ç¨‹ + æ•°æ®åˆ’åˆ†ï¼‰
2. è®­ç»ƒRandom Forestæ¨¡å‹
3. è®­ç»ƒXGBoostæ¨¡å‹
4. è®­ç»ƒLSTMæ¨¡å‹
5. è®­ç»ƒTransformeræ¨¡å‹
6. ä¸Šä¼ æ‰€æœ‰æ¨¡å‹åˆ°COS

#### æ­¥éª¤5ï¼šå‰ç«¯é¢„æµ‹ä½¿ç”¨æœ€æ–°æ•°æ®
```python
# api/predict.py è‡ªåŠ¨åŠ è½½åˆå¹¶æ•°æ®
LOTTERY_HISTORY = get_lottery_history()  # åŒ…å«ç”¨æˆ·æ–°å¢æ•°æ®
predictor = MLPredictor(LOTTERY_HISTORY)
```

---

## é…ç½®è¦æ±‚

### å¿…éœ€é…ç½®

**è…¾è®¯äº‘COSç¯å¢ƒå˜é‡**ï¼ˆç”¨äºæ•°æ®åŒæ­¥å’Œæ¨¡å‹ä¸Šä¼ ï¼‰ï¼š
```bash
export TENCENT_SECRET_ID=your_secret_id
export TENCENT_SECRET_KEY=your_secret_key
export TENCENT_COS_BUCKET=your_bucket_name
export TENCENT_COS_REGION=ap-guangzhou
```

### å¯é€‰é…ç½®

**è®­ç»ƒå‚æ•°**ï¼š
- è®­ç»ƒæ•°æ®çª—å£å¤§å°ï¼š10æœŸï¼ˆå¯åœ¨ `_training_trigger.py` ä¿®æ”¹ï¼‰
- è®­ç»ƒ/æµ‹è¯•é›†åˆ’åˆ†æ¯”ä¾‹ï¼š80/20
- æ¨¡å‹å‚æ•°ï¼šè§ `scripts/train_models.py`

---

## ä¼˜åŠ¿å’Œç‰¹ç‚¹

### âœ… å®Œå…¨è‡ªåŠ¨åŒ–
- æ·»åŠ 1æ¡æ•°æ®å³è§¦å‘å®Œæ•´æµç¨‹
- æ— éœ€æ‰‹åŠ¨è¿è¡Œä»»ä½•è„šæœ¬
- åå°å¼‚æ­¥è®­ç»ƒä¸é˜»å¡ç”¨æˆ·æ“ä½œ

### âœ… æ•°æ®ä¸€è‡´æ€§
- æœ¬åœ°æ–‡ä»¶ã€COSã€æ¨¡å‹è®­ç»ƒæ•°æ®ä¸‰æ–¹åŒæ­¥
- é¢„æµ‹APIè‡ªåŠ¨ä½¿ç”¨æœ€æ–°æ•°æ®

### âœ… å¯è¿½æº¯æ€§
- è®­ç»ƒçŠ¶æ€å¯æŸ¥è¯¢
- è®­ç»ƒæ—¥å¿—æŒä¹…åŒ–ä¿å­˜
- æ•°æ®æ·»åŠ æ—¶é—´æˆ³è®°å½•

### âœ… å®¹é”™æœºåˆ¶
- COSæœªé…ç½®æ—¶ä»å¯æœ¬åœ°ä½¿ç”¨
- è®­ç»ƒå¤±è´¥ä¸å½±å“æ•°æ®ä¿å­˜
- æ¨¡å—å¯¼å…¥å¤±è´¥æ—¶é™çº§åˆ°åŸºç¡€åŠŸèƒ½

---

## æŠ€æœ¯å®ç°

### å¼‚æ­¥è®­ç»ƒæœºåˆ¶

ä½¿ç”¨Pythonå¤šçº¿ç¨‹å®ç°åå°è®­ç»ƒï¼š
```python
thread = threading.Thread(
    target=training_task,
    args=(combined_data,),
    daemon=True
)
thread.start()
```

### è®­ç»ƒçŠ¶æ€ç®¡ç†

ä½¿ç”¨JSONæ–‡ä»¶å­˜å‚¨è®­ç»ƒçŠ¶æ€ï¼š
```python
# /tmp/training_status.json
{
  "status": "running",
  "message": "æ­£åœ¨è®­ç»ƒæ¨¡å‹...",
  "started_at": "2026-01-25T12:00:00",
  "updated_at": "2026-01-25T12:05:00"
}
```

### æ•°æ®ç‰ˆæœ¬æ§åˆ¶

æ¯æ¬¡åŒæ­¥éƒ½ä¼šæ›´æ–°æ—¶é—´æˆ³ï¼š
```python
{
  "data": [...],
  "last_updated": "2026-01-25T12:00:00",
  "source": "admin-manual-add",
  "version": "1.0"
}
```

---

## ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
```bash
tail -f /tmp/training_log.txt
```

### æŸ¥çœ‹è®­ç»ƒçŠ¶æ€
```bash
cat /tmp/training_status.json
```

### æ‰‹åŠ¨è§¦å‘è®­ç»ƒ
```python
from api.utils._training_trigger import trigger_training
from api.utils._lottery_data import lottery_data

result = trigger_training(lottery_data)
print(result)
```

### æ‰‹åŠ¨åŒæ­¥æ•°æ®
```python
from api.utils._data_sync import sync_new_data

new_records = [
    {
        'period': '25999',
        'date': '2026-01-25',
        'front_zone': [1, 5, 10, 15, 20],
        'back_zone': [3, 7]
    }
]

result = sync_new_data(new_records, combined_data)
print(result)
```

---

## æ³¨æ„äº‹é¡¹

### è®­ç»ƒæ—¶é—´
- å®Œæ•´è®­ç»ƒ4ä¸ªæ¨¡å‹çº¦éœ€ **5-15åˆ†é’Ÿ**ï¼ˆå–å†³äºæ•°æ®é‡å’Œç¡¬ä»¶ï¼‰
- è®­ç»ƒæœŸé—´å¯ç»§ç»­ä½¿ç”¨å…¶ä»–åŠŸèƒ½
- å¤šæ¬¡æ·»åŠ æ•°æ®ä¼šç´¯ç§¯ï¼Œåªè¿è¡Œä¸€æ¬¡è®­ç»ƒä»»åŠ¡

### èµ„æºæ¶ˆè€—
- è®­ç»ƒè¿‡ç¨‹ä¼šå ç”¨è¾ƒå¤šCPUå’Œå†…å­˜
- Vercel Serverlessç¯å¢ƒä¸­è®­ç»ƒå¯èƒ½è¶…æ—¶ï¼Œå»ºè®®ä½¿ç”¨æœ¬åœ°æˆ–é•¿æ—¶è¿è¡Œç¯å¢ƒ

### COSå­˜å‚¨
- æ¯æ¬¡æ·»åŠ æ•°æ®éƒ½ä¼šä¸Šä¼ å®Œæ•´å†å²è®°å½•
- æ¨¡å‹æ–‡ä»¶è¾ƒå¤§ï¼ˆLSTM/Transformerçº¦10-50MBï¼‰
- æ³¨æ„COSæµé‡è´¹ç”¨

---

## æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šè®­ç»ƒä¸€ç›´æ˜¾ç¤º"è¿è¡Œä¸­"
**åŸå› **ï¼šè®­ç»ƒè„šæœ¬å¼‚å¸¸é€€å‡º
**è§£å†³**ï¼šæŸ¥çœ‹æ—¥å¿— `/tmp/training_log.txt`

### é—®é¢˜2ï¼šCOSä¸Šä¼ å¤±è´¥
**åŸå› **ï¼šç¯å¢ƒå˜é‡æœªé…ç½®æˆ–æƒé™ä¸è¶³
**è§£å†³**ï¼šæ£€æŸ¥ `TENCENT_*` ç¯å¢ƒå˜é‡

### é—®é¢˜3ï¼šé¢„æµ‹æœªä½¿ç”¨æ–°æ•°æ®
**åŸå› **ï¼šç¼“å­˜æˆ–å¯¼å…¥å¤±è´¥
**è§£å†³**ï¼šé‡å¯APIæœåŠ¡æˆ–æ£€æŸ¥ `predict.py` æ—¥å¿—

---

## ç‰ˆæœ¬å†å²

**v1.0** (2026-01-25)
- âœ… å®ç°è‡ªåŠ¨æ•°æ®åŒæ­¥
- âœ… å®ç°è‡ªåŠ¨æ¨¡å‹è®­ç»ƒ
- âœ… é›†æˆåˆ°åå°ç®¡ç†ç³»ç»Ÿ
- âœ… é¢„æµ‹APIè‡ªåŠ¨ä½¿ç”¨æœ€æ–°æ•°æ®

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `api/utils/_data_sync.py` | æ•°æ®åŒæ­¥æ¨¡å— |
| `api/utils/_training_trigger.py` | è®­ç»ƒè§¦å‘å™¨ |
| `api/admin-data.py` | ç®¡ç†APIï¼ˆå·²å¢å¼ºï¼‰ |
| `api/predict.py` | é¢„æµ‹APIï¼ˆå·²æ›´æ–°ï¼‰ |
| `scripts/train_models.py` | æ¨¡å‹è®­ç»ƒè„šæœ¬ |
| `/tmp/user_lottery_data.json` | ç”¨æˆ·æ·»åŠ çš„æ•°æ® |
| `/tmp/training_status.json` | è®­ç»ƒçŠ¶æ€ |
| `/tmp/training_log.txt` | è®­ç»ƒæ—¥å¿— |

---

**é—®é¢˜åé¦ˆ**ï¼šå¦‚æœ‰é—®é¢˜è¯·æäº¤Issueæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
