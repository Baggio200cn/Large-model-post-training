<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - å¤§ä¹é€AIé¢„æµ‹ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .card-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-bar {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-green { background: #00b894; }
        .status-red { background: #e74c3c; }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: linear-gradient(90deg, #667eea, #764ba2); color: #fff; }
        .btn-success { background: linear-gradient(90deg, #00b894, #00cec9); color: #fff; }
        .btn-warning { background: linear-gradient(90deg, #fdcb6e, #f39c12); color: #000; }
        .btn-info { background: linear-gradient(90deg, #0984e3, #74b9ff); color: #fff; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 14px;
        }
        input::placeholder { color: rgba(255,255,255,0.5); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .message.show { display: block; }
        .message.success { background: rgba(0,184,148,0.3); border: 1px solid #00b894; }
        .message.error { background: rgba(231,76,60,0.3); border: 1px solid #e74c3c; }
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .history-item {
            background: rgba(0,0,0,0.2);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .ball {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            margin: 0 2px;
        }
        .ball-red { background: #e74c3c; }
        .ball-blue { background: #3498db; }
        .back-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            color: #fff;
        }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ åå°ç®¡ç†</h1>
            <p>æ•°æ®ç®¡ç† | ç³»ç»Ÿç›‘æ§ | Vercel KV å­˜å‚¨</p>
        </div>

        <div class="card">
            <div class="card-title">ğŸ”Œ Vercel KV çŠ¶æ€</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="kvDot"></div>
                    <span id="kvStatus">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="status-item">
                    <span>ğŸ“Š æ•°æ®æº: <strong id="dataSource">--</strong></span>
                </div>
                <div class="status-item">
                    <span>ğŸ“ˆ æœ€æ–°æœŸå·: <strong id="latestPeriod">--</strong></span>
                </div>
                <div class="status-item">
                    <span>ğŸ“ æ€»æœŸæ•°: <strong id="totalPeriods">--</strong></span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“¥ æ•°æ®æ“ä½œ</div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                <button class="btn btn-info" onclick="fetchData()" id="fetchBtn">ğŸŒ è‡ªåŠ¨æŠ“å–æœ€æ–°æ•°æ®</button>
                <button class="btn btn-warning" onclick="initData()">ğŸš€ åˆå§‹åŒ–KVæ•°æ®</button>
            </div>
            <div id="operationMsg" class="message"></div>
        </div>

        <div class="card">
            <div class="card-title">â• æ‰‹åŠ¨æ·»åŠ å¼€å¥–æ•°æ®</div>
            <div class="form-row">
                <div class="form-group">
                    <label>æœŸå·</label>
                    <input type="text" id="addPeriod" placeholder="å¦‚: 25142">
                </div>
                <div class="form-group">
                    <label>å¼€å¥–æ—¥æœŸ</label>
                    <input type="date" id="addDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å‰åŒºå·ç ï¼ˆ5ä¸ªï¼Œç©ºæ ¼åˆ†éš”ï¼‰</label>
                    <input type="text" id="addFront" placeholder="å¦‚: 04 09 24 28 29">
                </div>
                <div class="form-group">
                    <label>ååŒºå·ç ï¼ˆ2ä¸ªï¼Œç©ºæ ¼åˆ†éš”ï¼‰</label>
                    <input type="text" id="addBack" placeholder="å¦‚: 02 10">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="autoFillNext()">ğŸ“ è‡ªåŠ¨å¡«å……ä¸‹æœŸ</button>
                <button class="btn btn-success" onclick="addData()">âœ… æ·»åŠ æ•°æ®</button>
            </div>
            <div id="addMsg" class="message"></div>
        </div>

        <div class="card">
            <div class="card-title">ğŸ“‹ æœ€è¿‘å¼€å¥–è®°å½•</div>
            <button class="btn btn-primary" onclick="loadHistory()">ğŸ“¥ åŠ è½½è®°å½•</button>
            <div id="historyList" class="history-list"></div>
        </div>
    </div>

    <a href="index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>

    <script>
        window.onload = function() { refreshStatus(); };

        async function refreshStatus() {
            try {
                const resp = await fetch('/api/admin-data');
                const data = await resp.json();
                const kvDot = document.getElementById('kvDot');
                const kvStatus = document.getElementById('kvStatus');
                if (data.kv_available) {
                    kvDot.className = 'status-dot status-green';
                    kvStatus.textContent = 'âœ“ å·²è¿æ¥ï¼Œæ•°æ®æŒä¹…åŒ–æ­£å¸¸';
                } else {
                    kvDot.className = 'status-dot status-red';
                    kvStatus.textContent = 'âœ— æœªè¿æ¥';
                }
                document.getElementById('dataSource').textContent = data.data_source || '--';
                document.getElementById('latestPeriod').textContent = data.latest_period || '--';
                document.getElementById('totalPeriods').textContent = data.total_periods || '--';
            } catch (e) {
                document.getElementById('kvStatus').textContent = 'æ£€æµ‹å¤±è´¥';
            }
        }

        async function fetchData() {
            const btn = document.getElementById('fetchBtn');
            const msg = document.getElementById('operationMsg');
            btn.disabled = true;
            btn.textContent = 'â³ æŠ“å–ä¸­...';
            try {
                const resp = await fetch('/api/admin-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'fetch'})
                });
                const data = await resp.json();
                msg.className = 'message show ' + (data.status === 'success' ? 'success' : 'error');
                msg.textContent = data.message || 'æ“ä½œå®Œæˆ';
                if (data.status === 'success') refreshStatus();
            } catch (e) {
                msg.className = 'message show error';
                msg.textContent = 'è¯·æ±‚å¤±è´¥: ' + e.message;
            }
            btn.disabled = false;
            btn.textContent = 'ğŸŒ è‡ªåŠ¨æŠ“å–æœ€æ–°æ•°æ®';
        }

        async function initData() {
            if (!confirm('ç¡®å®šè¦åˆå§‹åŒ–KVæ•°æ®ï¼Ÿ')) return;
            const msg = document.getElementById('operationMsg');
            try {
                const resp = await fetch('/api/admin-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'init'})
                });
                const data = await resp.json();
                msg.className = 'message show ' + (data.status === 'success' ? 'success' : 'error');
                msg.textContent = data.message || 'æ“ä½œå®Œæˆ';
                if (data.status === 'success') refreshStatus();
            } catch (e) {
                msg.className = 'message show error';
                msg.textContent = 'è¯·æ±‚å¤±è´¥';
            }
        }

        function autoFillNext() {
            const current = document.getElementById('latestPeriod').textContent;
            if (current && current !== '--') {
                document.getElementById('addPeriod').value = String(parseInt(current) + 1);
            }
            document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
        }

        async function addData() {
            const msg = document.getElementById('addMsg');
            const period = document.getElementById('addPeriod').value.trim();
            const date = document.getElementById('addDate').value;
            const frontStr = document.getElementById('addFront').value.trim();
            const backStr = document.getElementById('addBack').value.trim();
            if (!period || !frontStr || !backStr) {
                msg.className = 'message show error';
                msg.textContent = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
                return;
            }
            const front = frontStr.split(/\s+/).map(Number).filter(n => n > 0 && n <= 35);
            const back = backStr.split(/\s+/).map(Number).filter(n => n > 0 && n <= 12);
            if (front.length !== 5) {
                msg.className = 'message show error';
                msg.textContent = 'å‰åŒºéœ€è¦5ä¸ªæœ‰æ•ˆå·ç (1-35)';
                return;
            }
            if (back.length !== 2) {
                msg.className = 'message show error';
                msg.textContent = 'ååŒºéœ€è¦2ä¸ªæœ‰æ•ˆå·ç (1-12)';
                return;
            }
            try {
                const resp = await fetch('/api/admin-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'add', period, date, front, back})
                });
                const data = await resp.json();
                msg.className = 'message show ' + (data.status === 'success' ? 'success' : 'error');
                msg.textContent = data.message || 'æ“ä½œå®Œæˆ';
                if (data.status === 'success') {
                    refreshStatus();
                    document.getElementById('addPeriod').value = '';
                    document.getElementById('addFront').value = '';
                    document.getElementById('addBack').value = '';
                }
            } catch (e) {
                msg.className = 'message show error';
                msg.textContent = 'è¯·æ±‚å¤±è´¥';
            }
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '<p>åŠ è½½ä¸­...</p>';
            try {
                const resp = await fetch('/api/admin-data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'get_history', limit: 20})
                });
                const data = await resp.json();
                if (data.status === 'success' && data.history) {
                    list.innerHTML = data.history.map(item => {
                        const front = (item.front || []).map(n => '<span class="ball ball-red">' + String(n).padStart(2, '0') + '</span>').join('');
                        const back = (item.back || []).map(n => '<span class="ball ball-blue">' + String(n).padStart(2, '0') + '</span>').join('');
                        return '<div class="history-item"><span>ç¬¬ ' + item.period + ' æœŸ (' + (item.date || '--') + ')</span><span>' + front + ' + ' + back + '</span></div>';
                    }).join('');
                } else {
                    list.innerHTML = '<p style="color:#e74c3c;">åŠ è½½å¤±è´¥</p>';
                }
            } catch (e) {
                list.innerHTML = '<p style="color:#e74c3c;">è¯·æ±‚å¤±è´¥</p>';
            }
        }
    </script>
</body>
</html>
