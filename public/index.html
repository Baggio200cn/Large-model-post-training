<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ä¹é€AIé¢„æµ‹ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 1.5em; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .card-title {
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lottery-bar {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            border-radius: 50px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .ball {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        .ball-red { background: linear-gradient(145deg, #ff6b6b, #ee5a5a); }
        .ball-blue { background: linear-gradient(145deg, #4facfe, #00f2fe); }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: linear-gradient(90deg, #667eea, #764ba2); color: #fff; }
        .btn-success { background: linear-gradient(90deg, #00b894, #00cec9); color: #fff; }
        .btn-warning { background: linear-gradient(90deg, #fdcb6e, #f39c12); color: #000; }
        .btn-danger { background: linear-gradient(90deg, #e74c3c, #c0392b); color: #fff; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .result-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
        }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .fusion-card {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
            border: 2px solid #ffd700;
        }
        .fusion-numbers {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .fusion-ball {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .fusion-red { background: linear-gradient(145deg, #ff4757, #ff6b81); color: #fff; }
        .fusion-blue { background: linear-gradient(145deg, #3742fa, #5352ed); color: #fff; }
        .tweet-section { margin-top: 20px; }
        .tweet-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; }
        .tweet-result {
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            padding: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }
        .tweet-actions { margin-top: 15px; display: flex; gap: 10px; }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            background: #00b894;
        }
        .admin-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            color: #fff;
            font-size: 14px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            resize: vertical;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ·±åº¦å­¦ä¹  + çµä¿®ç›´è§‰ = å¤šç»´åº¦èåˆé¢„æµ‹</h1>
        </div>

        <div class="lottery-bar">
            <span>ğŸ† æœ€æ–°å¼€å¥–</span>
            <div id="latestNumbers" style="display:flex;gap:8px;align-items:center;">
                <span>åŠ è½½ä¸­...</span>
            </div>
            <span class="status-badge" id="dataStatus">åŠ è½½ä¸­</span>
            <span id="latestPeriod" style="margin-left:auto;"></span>
        </div>

        <div class="card fusion-card">
            <div class="card-title">ğŸ”® æœ€ç»ˆèåˆé¢„æµ‹</div>
            <p style="color:#ccc;margin-bottom:15px;">MLæœºå™¨å­¦ä¹ (70%) + çµä¿®ç›´è§‰(30%) = æ™ºèƒ½èåˆé¢„æµ‹</p>
            <button class="btn btn-warning" onclick="generateFusionPrediction()">âš¡ ç”Ÿæˆèåˆé¢„æµ‹</button>
            <div id="fusionLoading" class="loading"><div class="spinner"></div><p>æ­£åœ¨èåˆè®¡ç®—...</p></div>
            <div id="fusionResult" style="display:none;margin-top:20px;">
                <p style="color:#ffd700;margin-bottom:10px;">ğŸ¯ <strong>ç¬¬<span id="fusionPeriod"></span>æœŸ æ¨èå·ç </strong></p>
                <div class="fusion-numbers">
                    <span style="color:#ff6b6b;">å‰åŒºï¼š</span>
                    <div id="fusionFront" style="display:flex;gap:8px;"></div>
                    <span style="margin-left:20px;color:#5dade2;">ååŒºï¼š</span>
                    <div id="fusionBack" style="display:flex;gap:8px;"></div>
                </div>
                <p style="margin-top:15px;">ğŸ“Š ç»¼åˆç½®ä¿¡åº¦ï¼š<strong id="fusionConfidence"></strong></p>
                <button class="btn btn-success" onclick="copyFusion()" style="margin-top:10px;">ğŸ“‹ å¤åˆ¶å·ç </button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-title">ğŸ¤– MLæœºå™¨å­¦ä¹ é¢„æµ‹</div>
                <p style="color:#aaa;margin-bottom:15px;">åŸºäºLSTMã€Transformerã€XGBoostã€RandomForestå››æ¨¡å‹èåˆ</p>
                <button class="btn btn-primary" onclick="getMLPrediction()">ğŸ”® è·å–MLé¢„æµ‹</button>
                <div id="mlLoading" class="loading"><div class="spinner"></div></div>
                <div id="mlResult" class="result-box"></div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ§˜ çµä¿®ç›´è§‰é¢„æµ‹</div>
                <p style="color:#aaa;margin-bottom:15px;">ä¸Šä¼ å›¾ç‰‡æˆ–è¾“å…¥çµä¿®æ–‡å­—ï¼Œç³»ç»Ÿå°†æ„Ÿåº”èƒ½é‡åœºç”Ÿæˆé¢„æµ‹</p>
                <input type="file" id="spiritualImage" accept="image/*" style="display:none;" onchange="handleImageUpload(this)">
                <div style="background:rgba(255,255,255,0.05);border-radius:8px;padding:10px;margin-bottom:10px;">
                    <button class="btn" style="background:#9b59b6;color:#fff;width:100%;" onclick="document.getElementById('spiritualImage').click()">ğŸ“· ä¸Šä¼ å›¾ç‰‡ (å¯é€‰)</button>
                    <div id="imagePreview" style="margin-top:10px;display:none;">
                        <img id="previewImg" style="max-width:100%;max-height:150px;border-radius:8px;">
                        <button class="btn" style="background:#e74c3c;color:#fff;margin-top:5px;padding:5px 10px;font-size:12px;" onclick="clearImage()">åˆ é™¤å›¾ç‰‡</button>
                    </div>
                </div>
                <textarea id="spiritualText" rows="3" placeholder="ä¾‹å¦‚ï¼šä»Šæ—¥å¿ƒæƒ…å¹³é™ï¼Œæ„Ÿæ‚Ÿæ•°å­—8ã€15ã€23..."></textarea>
                <div style="margin-top:10px;display:flex;gap:10px;">
                    <button class="btn btn-success" onclick="getSpiritualPrediction()">ğŸ”® è·å–çµä¿®é¢„æµ‹</button>
                    <button class="btn" style="background:#666;" onclick="clearSpiritual()">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
                <div id="spiritualLoading" class="loading"><div class="spinner"></div></div>
                <div id="spiritualResult" class="result-box"></div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“Š æ•°æ®ç»Ÿè®¡åˆ†æ</div>
                <p style="color:#aaa;margin-bottom:15px;">åˆ†æå†å²æ•°æ®ï¼Œè¯†åˆ«å·ç é¢‘ç‡è§„å¾‹</p>
                <button class="btn btn-primary" onclick="getStatistics()">ğŸ“ˆ å¼€å§‹åˆ†æ</button>
                <div id="statsLoading" class="loading"><div class="spinner"></div></div>
                <div id="statsResult" class="result-box"></div>
            </div>

            <div class="card">
                <div class="card-title">âš™ï¸ ç³»ç»ŸçŠ¶æ€æ£€æµ‹</div>
                <p style="color:#aaa;margin-bottom:15px;">æ£€æµ‹APIè¿è¡ŒçŠ¶æ€å’Œæ•°æ®æº</p>
                <button class="btn btn-primary" onclick="checkSystem()">ğŸ” æ£€æµ‹ç³»ç»Ÿ</button>
                <div id="systemLoading" class="loading"><div class="spinner"></div></div>
                <div id="systemResult" class="result-box"></div>
            </div>
        </div>

        <div class="card tweet-section">
            <div class="card-title">ğŸ“ å…¬ä¼—å·æ¨æ–‡ç”Ÿæˆ</div>
            <p style="color:#aaa;margin-bottom:15px;">ä¸€é”®ç”Ÿæˆä¸“ä¸šçš„é¢„æµ‹åˆ†ææŠ¥å‘Šï¼Œå¯ç›´æ¥å‘å¸ƒåˆ°å…¬ä¼—å·</p>
            <div class="tweet-buttons">
                <button class="btn btn-primary" onclick="generateTweet('simple')">ğŸ“‹ ç®€æ´ç‰ˆæ¨æ–‡</button>
                <button class="btn btn-warning" onclick="generateTweet('detailed')">ğŸ“„ è¯¦ç»†ç‰ˆæŠ¥å‘Š</button>
                <button class="btn btn-danger" onclick="generateTweet('analysis')">ğŸ“Š ä¸“ä¸šåˆ†æç‰ˆ</button>
            </div>
            <div id="tweetResult" class="tweet-result"></div>
            <div id="tweetActions" class="tweet-actions" style="display:none;">
                <button class="btn btn-success" onclick="copyTweet()">ğŸ“‹ å¤åˆ¶å…¨æ–‡</button>
                <button class="btn btn-primary" onclick="downloadTweet()">ğŸ’¾ ä¸‹è½½MD</button>
            </div>
            <div id="tweetExtra" style="display:none;margin-top:15px;"></div>
        </div>
    </div>

    <a href="admin.html" class="admin-btn">âš™ï¸ åå°ç®¡ç†</a>

    <script>
        let latestData = null;
        let mlPrediction = null;
        let spiritualPrediction = null;
        let fusionPrediction = null;
        let uploadedImageBase64 = null;

        window.onload = function() { loadLatestData(); };

        async function loadLatestData() {
            try {
                const resp = await fetch('/api/latest-results');
                const data = await resp.json();
                latestData = data;
                if (data.status === 'success' && data.latest_result) {
                    const r = data.latest_result;
                    let html = '';
                    (r.front_zone || []).forEach(n => { html += '<div class="ball ball-red">' + String(n).padStart(2, '0') + '</div>'; });
                    html += '<span style="font-size:20px;">+</span>';
                    (r.back_zone || []).forEach(n => { html += '<div class="ball ball-blue">' + String(n).padStart(2, '0') + '</div>'; });
                    document.getElementById('latestNumbers').innerHTML = html;
                    document.getElementById('latestPeriod').textContent = 'ç¬¬ ' + r.period + ' æœŸ | ' + (r.date || '--');
                    document.getElementById('dataStatus').textContent = 'âœ“ ' + (data.data_source || 'OK');
                }
            } catch (e) {
                document.getElementById('latestNumbers').innerHTML = '<span style="color:#e74c3c;">åŠ è½½å¤±è´¥</span>';
            }
        }

        async function getMLPrediction() {
            const loading = document.getElementById('mlLoading');
            const result = document.getElementById('mlResult');
            loading.classList.add('show');
            result.innerHTML = '';
            try {
                // å…ˆè·å–latest-resultsçš„ml_predict
                const resp1 = await fetch('/api/latest-results', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'ml_predict'})
                });
                const data1 = await resp1.json();

                if (data1.status === 'success' && data1.ml_prediction) {
                    mlPrediction = data1.ml_prediction;
                    const p = data1.ml_prediction;
                    const targetPeriod = data1.target_period || '25143';

                    result.innerHTML = '<p style="color:#ffd700;margin-bottom:10px;">ğŸ¯ MLé›†æˆé¢„æµ‹ (ç¬¬' + targetPeriod + 'æœŸ)</p>' +
                        '<p><strong>å‰åŒºï¼š</strong> ' + p.front.join(', ') + '</p>' +
                        '<p><strong>ååŒºï¼š</strong> ' + p.back.join(', ') + '</p>' +
                        '<p><strong>ç½®ä¿¡åº¦ï¼š</strong> ' + (p.confidence * 100).toFixed(1) + '%</p>' +
                        '<hr style="border-color:rgba(255,255,255,0.2);margin:10px 0;">' +
                        '<p style="font-size:12px;color:#aaa;">å„æ¨¡å‹ï¼š</p>' +
                        Object.entries(p.individual_models || {}).map(function(e) {
                            return '<p style="font-size:12px;">' + e[0] + ': ' + e[1].front.join(',') + ' + ' + e[1].back.join(',') + '</p>';
                        }).join('');
                    loading.classList.remove('show');
                    return;
                }

                // å¦‚æœä¸Šé¢å¤±è´¥ï¼Œå°è¯•è°ƒç”¨/api/predict
                const resp2 = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });
                const data2 = await resp2.json();
                loading.classList.remove('show');

                if (data2.status === 'success' && data2.prediction) {
                    const pred = data2.prediction.ensemble_prediction || data2.prediction.all_predictions[0];
                    mlPrediction = {
                        front: pred.front_zone,
                        back: pred.back_zone,
                        confidence: pred.confidence,
                        individual_models: {}
                    };

                    // è½¬æ¢æ‰€æœ‰é¢„æµ‹åˆ°individual_modelsæ ¼å¼
                    if (data2.prediction.all_predictions) {
                        data2.prediction.all_predictions.forEach(function(p) {
                            mlPrediction.individual_models[p.strategy] = {
                                front: p.front_zone,
                                back: p.back_zone,
                                confidence: p.confidence
                            };
                        });
                    }

                    result.innerHTML = '<p style="color:#ffd700;margin-bottom:10px;">ğŸ¯ MLæœºå™¨å­¦ä¹ é¢„æµ‹</p>' +
                        '<p><strong>å‰åŒºï¼š</strong> ' + pred.front_zone.join(', ') + '</p>' +
                        '<p><strong>ååŒºï¼š</strong> ' + pred.back_zone.join(', ') + '</p>' +
                        '<p><strong>ç½®ä¿¡åº¦ï¼š</strong> ' + (pred.confidence * 100).toFixed(1) + '%</p>' +
                        '<p style="font-size:12px;color:#aaa;margin-top:10px;">ç­–ç•¥ï¼š' + pred.strategy + '</p>';
                } else {
                    result.innerHTML = '<p style="color:#e74c3c;">é¢„æµ‹å¤±è´¥</p>';
                }
            } catch (e) {
                loading.classList.remove('show');
                result.innerHTML = '<p style="color:#e74c3c;">è¯·æ±‚å¤±è´¥: ' + e.message + '</p>';
            }
        }

        async function getSpiritualPrediction() {
            const loading = document.getElementById('spiritualLoading');
            const result = document.getElementById('spiritualResult');
            const text = document.getElementById('spiritualText').value;
            loading.classList.add('show');
            result.innerHTML = '';
            try {
                // æ„å»ºè¯·æ±‚ä½“
                const requestBody = {
                    text: text || ''
                };

                // å¦‚æœæœ‰ä¸Šä¼ çš„å›¾ç‰‡ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (uploadedImageBase64) {
                    requestBody.image = uploadedImageBase64;
                }

                const resp = await fetch('/api/spiritual', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                const data = await resp.json();
                loading.classList.remove('show');

                let front = [], back = [], intensity = 0.7;
                let interpretation = '';

                if (data.success && data.spiritual_prediction) {
                    front = data.spiritual_prediction.front_zone || [];
                    back = data.spiritual_prediction.back_zone || [];
                    intensity = data.spiritual_prediction.energy || 0.7;
                    interpretation = data.interpretation || '';
                } else if (data.spiritual_prediction) {
                    front = data.spiritual_prediction.front_zone || [];
                    back = data.spiritual_prediction.back_zone || [];
                }

                if (data.energy_analysis) {
                    intensity = data.energy_analysis.intensity || intensity;
                }

                if (front.length === 0) {
                    front = genNums(5, 35);
                    back = genNums(2, 12);
                    intensity = 0.6 + Math.random() * 0.3;
                }

                spiritualPrediction = {front: front, back: back, intensity: intensity};

                let html = '<p style="color:#9b59b6;">ğŸ§˜ çµä¿®æ„Ÿåº”ç»“æœ</p>' +
                    '<p><strong>å‰åŒºï¼š</strong> ' + front.join(', ') + '</p>' +
                    '<p><strong>ååŒºï¼š</strong> ' + back.join(', ') + '</p>' +
                    '<p><strong>èƒ½é‡å¼ºåº¦ï¼š</strong> ' + (intensity * 100).toFixed(1) + '%</p>';

                if (interpretation) {
                    html += '<hr style="border-color:rgba(255,255,255,0.2);margin:10px 0;">' +
                        '<p style="font-size:12px;color:#aaa;white-space:pre-wrap;">' + interpretation + '</p>';
                }

                if (data.image_analysis) {
                    html += '<p style="font-size:12px;color:#aaa;margin-top:5px;">å›¾åƒä¸»è‰²è°ƒ: ' +
                        data.image_analysis.dominant_color + '</p>';
                }

                result.innerHTML = html;
            } catch (e) {
                loading.classList.remove('show');
                var front = genNums(5, 35), back = genNums(2, 12);
                spiritualPrediction = {front: front, back: back, intensity: 0.65};
                result.innerHTML = '<p style="color:#9b59b6;">ğŸ§˜ æœ¬åœ°çµä¿®æ„Ÿåº”</p>' +
                    '<p><strong>å‰åŒºï¼š</strong> ' + front.join(', ') + '</p>' +
                    '<p><strong>ååŒºï¼š</strong> ' + back.join(', ') + '</p>' +
                    '<p style="font-size:12px;color:#e74c3c;">æç¤º: ' + e.message + '</p>';
            }
        }

        function genNums(count, max) {
            var nums = new Set();
            while (nums.size < count) { nums.add(Math.floor(Math.random() * max) + 1); }
            return Array.from(nums).sort(function(a, b) { return a - b; });
        }

        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„å›¾ç‰‡');
                input.value = '';
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1]; // ç§»é™¤data:image/xxx;base64,å‰ç¼€
                uploadedImageBase64 = base64;

                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            uploadedImageBase64 = null;
            document.getElementById('spiritualImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImg').src = '';
        }

        function clearSpiritual() {
            document.getElementById('spiritualText').value = '';
            document.getElementById('spiritualResult').innerHTML = '';
            spiritualPrediction = null;
            clearImage();
        }

        async function generateFusionPrediction() {
            var loading = document.getElementById('fusionLoading');
            var result = document.getElementById('fusionResult');
            loading.classList.add('show');
            result.style.display = 'none';
            if (!mlPrediction) { await getMLPrediction(); }
            if (!spiritualPrediction) { await getSpiritualPrediction(); }
            loading.classList.remove('show');
            if (!mlPrediction || !spiritualPrediction) { alert('è¯·å…ˆè·å–é¢„æµ‹ï¼'); return; }
            var frontF = fusion(mlPrediction.front, spiritualPrediction.front, 0.7, 0.3, 5, 35);
            var backF = fusion(mlPrediction.back, spiritualPrediction.back, 0.7, 0.3, 2, 12);
            var conf = mlPrediction.confidence * 0.7 + (spiritualPrediction.intensity || 0.7) * 0.3;
            var period = latestData && latestData.latest_result ? String(parseInt(latestData.latest_result.period) + 1) : '25142';
            fusionPrediction = {front: frontF, back: backF, confidence: conf, target_period: period};
            document.getElementById('fusionPeriod').textContent = period;
            document.getElementById('fusionFront').innerHTML = frontF.map(function(n) {
                return '<div class="fusion-ball fusion-red">' + String(n).padStart(2, '0') + '</div>';
            }).join('');
            document.getElementById('fusionBack').innerHTML = backF.map(function(n) {
                return '<div class="fusion-ball fusion-blue">' + String(n).padStart(2, '0') + '</div>';
            }).join('');
            document.getElementById('fusionConfidence').textContent = (conf * 100).toFixed(1) + '%';
            result.style.display = 'block';
        }

        function fusion(ml, sp, mlW, spW, count, max) {
            var scores = {};
            ml.forEach(function(n, i) { scores[n] = (scores[n] || 0) + mlW * (count - i); });
            sp.forEach(function(n, i) { scores[n] = (scores[n] || 0) + spW * (count - i); });
            var sorted = Object.entries(scores).sort(function(a, b) { return b[1] - a[1]; }).map(function(x) { return parseInt(x[0]); });
            var result = sorted.slice(0, count);
            while (result.length < count) {
                var n = Math.floor(Math.random() * max) + 1;
                if (result.indexOf(n) === -1) result.push(n);
            }
            return result.sort(function(a, b) { return a - b; });
        }

        function copyFusion() {
            if (fusionPrediction) {
                var text = 'å‰åŒºï¼š' + fusionPrediction.front.join(' ') + ' ååŒºï¼š' + fusionPrediction.back.join(' ');
                navigator.clipboard.writeText(text).then(function() { alert('å·²å¤åˆ¶ï¼'); });
            }
        }

        async function getStatistics() {
            var loading = document.getElementById('statsLoading');
            var result = document.getElementById('statsResult');
            loading.classList.add('show');
            result.innerHTML = '';
            try {
                var resp = await fetch('/api/latest-results', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: 'statistics'})
                });
                var data = await resp.json();
                loading.classList.remove('show');
                if (data.status === 'success' && data.statistics) {
                    var s = data.statistics;
                    result.innerHTML = '<p style="color:#ffd700;">ğŸ“Š åŸºäº ' + s.total_periods + ' æœŸæ•°æ®åˆ†æ</p>' +
                        '<div class="info-grid">' +
                        '<div class="info-item"><p style="color:#00b894;">ğŸ”¥ å‰åŒºçƒ­é—¨</p><p>' + (s.front_hot || []).map(function(n) { return n.number; }).join(', ') + '</p></div>' +
                        '<div class="info-item"><p style="color:#3498db;">â„ï¸ å‰åŒºå†·é—¨</p><p>' + (s.front_cold || []).map(function(n) { return n.number; }).join(', ') + '</p></div>' +
                        '<div class="info-item"><p style="color:#00b894;">ğŸ”¥ ååŒºçƒ­é—¨</p><p>' + (s.back_hot || []).map(function(n) { return n.number; }).join(', ') + '</p></div>' +
                        '<div class="info-item"><p style="color:#e74c3c;">â° å‰åŒºé—æ¼</p><p>' + (s.front_overdue || []).slice(0,5).map(function(n) { return n.number + '(' + n.periods + 'æœŸ)'; }).join(', ') + '</p></div>' +
                        '</div>';
                }
            } catch (e) {
                loading.classList.remove('show');
                result.innerHTML = '<p style="color:#e74c3c;">åˆ†æå¤±è´¥</p>';
            }
        }

        async function checkSystem() {
            var loading = document.getElementById('systemLoading');
            var result = document.getElementById('systemResult');
            loading.classList.add('show');
            result.innerHTML = '';
            try {
                var resp = await fetch('/api/health');
                var data = await resp.json();
                loading.classList.remove('show');
                result.innerHTML = '<p>ğŸ”¹ æœåŠ¡ç‰ˆæœ¬: ' + (data.version || '--') + '</p>' +
                    '<p>ğŸ”¹ APIçŠ¶æ€: ' + (data.status || '--') + '</p>' +
                    '<p>ğŸ”¹ æ•°æ®æº: ' + (data.data_source || '--') + '</p>' +
                    '<p>ğŸ”¹ KVå¯ç”¨: ' + (data.kv_available ? 'æ˜¯' : 'å¦') + '</p>' +
                    '<p>ğŸ”¹ å†å²æ•°æ®: ' + (data.total_periods || '--') + ' æœŸ</p>' +
                    '<p>ğŸ”¹ æ£€æµ‹æ—¶é—´: ' + new Date().toLocaleString() + '</p>';
            } catch (e) {
                loading.classList.remove('show');
                result.innerHTML = '<p style="color:#e74c3c;">æ£€æµ‹å¤±è´¥</p>';
            }
        }

        async function generateTweet(type) {
            var resultDiv = document.getElementById('tweetResult');
            var actionsDiv = document.getElementById('tweetActions');
            var extraDiv = document.getElementById('tweetExtra');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'ğŸ¤– æ­£åœ¨ç”Ÿæˆæ¨æ–‡...';
            actionsDiv.style.display = 'none';
            extraDiv.style.display = 'none';
            if (!fusionPrediction) { await generateFusionPrediction(); }
            if (!fusionPrediction) { resultDiv.textContent = 'è¯·å…ˆç”Ÿæˆèåˆé¢„æµ‹ï¼'; return; }
            try {
                var resp = await fetch('/api/generate-tweet', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: type,
                        target_period: fusionPrediction.target_period,
                        prediction: {front: fusionPrediction.front, back: fusionPrediction.back, confidence: fusionPrediction.confidence},
                        last_actual: latestData && latestData.latest_result ? {front: latestData.latest_result.front_zone, back: latestData.latest_result.back_zone} : null,
                        ml_models: mlPrediction ? mlPrediction.individual_models : null
                    })
                });
                var data = await resp.json();
                if (data.status === 'success') {
                    resultDiv.textContent = data.article;
                    actionsDiv.style.display = 'flex';
                    var extra = '';
                    if (data.deepseek_enhanced) { extra += '<p style="color:#00b894;">âœ… å·²ç”±DeepSeek AIä¼˜åŒ–</p>'; }
                    if (data.image_prompt) {
                        extra += '<div style="background:rgba(243,156,18,0.2);padding:10px;border-radius:8px;margin-top:10px;">' +
                            '<p style="color:#f39c12;">ğŸ¨ æ’å›¾æç¤ºè¯ï¼š</p>' +
                            '<p style="font-size:12px;color:#ccc;">' + data.image_prompt + '</p>' +
                            '<button class="btn" style="background:#f39c12;color:#000;margin-top:8px;padding:5px 10px;font-size:12px;" onclick="copyText(\'' + data.image_prompt.replace(/'/g, "\\'") + '\')">å¤åˆ¶</button></div>';
                    }
                    if (data.ml_knowledge) {
                        extra += '<div style="background:rgba(0,212,255,0.1);padding:10px;border-radius:8px;margin-top:10px;">' +
                            '<p style="color:#00d4ff;">ğŸ§  ' + data.ml_knowledge.title + '</p>' +
                            '<p style="font-size:12px;color:#aaa;">' + data.ml_knowledge.content + '</p></div>';
                    }
                    if (extra) { extraDiv.innerHTML = extra; extraDiv.style.display = 'block'; }
                } else {
                    resultDiv.textContent = localTweet(type);
                    actionsDiv.style.display = 'flex';
                }
            } catch (e) {
                resultDiv.textContent = localTweet(type);
                actionsDiv.style.display = 'flex';
            }
        }

        function localTweet(type) {
            var date = new Date().toLocaleDateString('zh-CN');
            var period = fusionPrediction.target_period;
            var front = fusionPrediction.front.map(function(n) { return String(n).padStart(2, '0'); }).join(' ');
            var back = fusionPrediction.back.map(function(n) { return String(n).padStart(2, '0'); }).join(' ');
            var conf = (fusionPrediction.confidence * 100).toFixed(1);
            var text = '# ğŸ¯ å¤§ä¹é€ç¬¬' + period + 'æœŸAIé¢„æµ‹\n\nğŸ“… ' + date + '\n\n---\n\n';
            text += '## ğŸ¯ é¢„æµ‹å·ç \n\n**ğŸ”´ å‰åŒºï¼š** ' + front + '\n\n**ğŸ”µ ååŒºï¼š** ' + back + '\n\n**ğŸ“Š ç½®ä¿¡åº¦ï¼š** ' + conf + '%\n\n';
            if (type !== 'simple' && mlPrediction) {
                text += '---\n\n## ğŸ¤– æ¨¡å‹è¯¦æƒ…\n\n| æ¨¡å‹ | å‰åŒº | ååŒº | ç½®ä¿¡åº¦ |\n|:---:|:---:|:---:|:---:|\n';
                Object.entries(mlPrediction.individual_models || {}).forEach(function(e) {
                    text += '| ' + e[0] + ' | ' + e[1].front.join(',') + ' | ' + e[1].back.join(',') + ' | ' + (e[1].confidence*100).toFixed(0) + '% |\n';
                });
            }
            text += '\n---\n\nâš ï¸ ä»…ä¾›å‚è€ƒï¼Œç†æ€§è´­å½©\n\n*AIé¢„æµ‹ç³»ç»Ÿ*\n';
            return text;
        }

        function copyText(text) { navigator.clipboard.writeText(text).then(function() { alert('å·²å¤åˆ¶ï¼'); }); }
        function copyTweet() { var text = document.getElementById('tweetResult').textContent; navigator.clipboard.writeText(text).then(function() { alert('æ¨æ–‡å·²å¤åˆ¶ï¼'); }); }
        function downloadTweet() {
            var text = document.getElementById('tweetResult').textContent;
            var blob = new Blob([text], {type: 'text/markdown'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'å¤§ä¹é€é¢„æµ‹_' + (fusionPrediction ? fusionPrediction.target_period : 'report') + '.md';
            a.click();
        }
    </script>
</body>
</html>
